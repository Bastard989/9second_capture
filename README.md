# 9second_capture

`9second_capture` — локальный агент для записи интервью, транскрибации и подготовки сравнимых аналитических сводок для команды найма.

## Для тех, кто не из IT
Этот продукт нужен, когда интервью проводят разные интервьюеры, а решение о кандидате принимает более широкая группа. Агент записывает встречу, сохраняет итоговый аудиофайл, готовит сырой и очищенный текст, а затем формирует отчёт, который можно быстро прочитать и сравнить с другими интервью.

Главная идея прод-версии: результат должен быть воспроизводимым и одинаково понятным для всех. Поэтому после каждой сессии формируется канонический `meeting_audio.mp3`, а не только фрагменты live-потока. Даже если захват шёл через разные режимы (системный звук, экран+аудио, загрузка файла, fallback-рекордер), на выходе всегда остаётся единый MP3-артефакт встречи.

В интерфейсе записи автоматически получают имена `Запись 1`, `Запись 2`, `Запись 3...`, их можно переименовать через меню `...`, а после завершения записи пользователь сразу получает предложение сохранить MP3 в удобное место.

## Установка с нуля (пошагово)
Если вы обычный пользователь, агент лучше брать как готовый бинарник из релизов репозитория:
- [GitHub Releases](https://github.com/Bastard989/9second_capture/releases)
- для Windows также доступен CI-артефакт workflow `Desktop Windows Build` (`9second_capture-windows`).

Если вы устанавливаете агент с нуля из исходников, используйте один из сценариев ниже.

### 1) Скачать проект (через Git)
```bash
git clone git@github.com:Bastard989/9second_capture.git
cd 9second_capture
git pull
```

Альтернатива без SSH:
```bash
git clone https://github.com/Bastard989/9second_capture.git
cd 9second_capture
git pull
```

### 2) Запустить агент (команды для копипаста)
macOS:
```bash
bash tools/packaging/build_mac.sh
open -n dist/9second_capture.app
```

Windows (PowerShell):
```powershell
powershell -ExecutionPolicy Bypass -File tools/packaging/build_windows.ps1
.\dist\9second_capture\9second_capture.exe
```

Linux:
```bash
bash tools/packaging/build_linux.sh
./dist/9second_capture/9second_capture
```

### 3) Первый рабочий запуск
После старта launcher:
1. Нажмите `Исправить в 1 клик`.
2. Нажмите `Открыть UI агента`.
3. Выберите источник аудио и запустите проверку перед записью.
4. Нажмите `Старт` для интервью и `Стоп` в конце.
5. Подтвердите сохранение итогового MP3.

## LLM под капотом: зачем она нужна в этом проекте
LLM в `9second_capture` не заменяет распознавание речи, а усиливает качество аналитики после STT. Базовый текст сначала получает ASR-движок (Whisper), а затем LLM используется в тех местах, где нужна интерпретация смысла и более аккуратная структура.

По факту LLM выполняет четыре основные функции:
- улучшает итоговый `clean`-транскрипт после встречи (исправляет типичные ASR-ошибки и сглаживает текст без добавления новых фактов);
- формирует аналитический отчёт по единой схеме (summary, scorecard, decision, data_quality), чтобы отчёты были сравнимыми между разными интервью;
- строит структурированные таблицы (`structured`) из транскрипта и отчёта для экспорта в CSV/JSON;
- опционально может участвовать в live-cleanup во время записи (по умолчанию этот режим выключен для стабильности и задержки).

Почему это важно для вашей цели: LLM превращает “сырой поток реплик” в унифицированный формат оценки кандидата, где есть критерии, сигналы риска, confidence и явный статус решения. За счёт этого руководитель или любой участник процесса найма, который не присутствовал на интервью, читает не хаотичный текст, а сопоставимый отчёт.

Если LLM недоступна или выключена, агент продолжает работать: запись, транскрипт и MP3 сохраняются, а отчёты/таблицы генерируются в fallback-режиме на эвристиках с пометкой по качеству данных. То есть пайплайн не падает, но глубина аналитики ниже.

## Что подходит для прод-использования командой
`9second_capture` уже ориентирован не только на локальный тест одного пользователя:

- есть preflight-диагностика перед записью (аудио, STT warmup, LLM доступность, профили качества);
- есть quality-профили `Fast / Balanced / Accurate`;
- есть fallback на итоговый MP3 и финальный pass после встречи;
- есть WER/регрессионные тесты и release-гейты в CI;
- есть desktop launcher для конечных пользователей и отдельный technical path для инженеров.

## Установка для конечных пользователей (бинарники)
### macOS
Если вы распространяете готовую сборку внутри компании, пользователь запускает приложение `9second_capture.app`.

Если нужно собрать из исходников:
```bash
bash tools/packaging/build_mac.sh
open -n dist/9second_capture.app
```

### Windows
Для пользователей Windows рекомендуемый путь — готовый артефакт из CI (`Desktop Windows Build`, артефакт `9second_capture-windows`).

Локальная сборка на Windows:
```powershell
powershell -ExecutionPolicy Bypass -File tools/packaging/build_windows.ps1
.\dist\9second_capture\9second_capture.exe
```

### Linux
Локальная сборка Linux launcher:
```bash
bash tools/packaging/build_linux.sh
./dist/9second_capture/9second_capture
```

## Первый запуск для интервьюера
После старта launcher открывает мастер установки. В нормальном сценарии пользователь нажимает `Исправить в 1 клик`, затем `Открыть UI агента`, проверяет доступ к аудио/экрану и начинает запись. В конце встречи система завершает обработку и предлагает сохранить MP3.

## Где хранятся данные
Для desktop-сценария launcher хранит рабочие данные в пользовательской папке:
- `~/.9second_capture/records/<meeting_id>/meeting_audio.mp3`
- `~/.9second_capture/records/<meeting_id>/raw.txt`
- `~/.9second_capture/records/<meeting_id>/clean.txt`
- `~/.9second_capture/records/<meeting_id>/report_*.json|txt`
- `~/.9second_capture/records/<meeting_id>/structured_*.json|csv`
- `~/.9second_capture/records/<meeting_id>/meeting_meta.json`

Для dev/server-запуска путь задаётся через `RECORDS_DIR` (по умолчанию `./data/records`).

Quick fallback-рекордер хранит отдельные файлы в `QUICK_RECORD_OUTPUT_DIR` (по умолчанию `./data/records/quick`).

## MP3 fallback (гарантированный артефакт)
При финализации встречи сервис пытается материализовать `meeting_audio.mp3` в таком порядке:

1. `backup_audio.*` (live/fallback поток);
2. `source_upload.*` (постфактум загруженный файл);
3. `chunks/0.bin` или `chunks/1.bin` как аварийный путь.

Если исходник не MP3, используется `ffmpeg` для перекодирования.

## LLM и Ollama
Для локальной LLM (без внешнего облака) поддерживается OpenAI-compatible endpoint, включая Ollama.

Пример установки Ollama:
```bash
# macOS
brew install --cask ollama
open -a Ollama
ollama pull llama3.1:8b
ollama list
```

В UI можно сканировать доступные модели и переключать активную без правки кода.

## Техническая часть
### Архитектура
- `apps/api_gateway` — API + WebSocket + встроенный UI.
- `src/interview_analytics_agent` — STT/LLM, постобработка, отчёты и storage.
- `scripts/launcher.py` — desktop launcher (установка зависимостей, preflight, запуск UI).
- `scripts/run_local_agent.py` — инженерный запуск сервиса без упаковки.

### Ключевые API для прод-интеграций
- `GET /v1/diagnostics/preflight` — готовность STT/LLM и профили качества.
- `GET /v1/meetings` — список встреч и метаинформация.
- `POST /v1/meetings/{id}/rename` — переименование записи.
- `GET /v1/meetings/{id}/artifact?kind=audio&fmt=mp3` — итоговый MP3.
- `POST /v1/meetings/{id}/finish` — финализация и materialize артефактов.

### Прод-конфигурация (минимум)
```bash
APP_ENV=prod
AUTH_MODE=api_key
API_KEYS=<user_keys>
SERVICE_API_KEYS=<service_keys>
RECORDS_DIR=/var/lib/9second_capture/records
```

Для локальной LLM/Ollama:
```bash
LLM_ENABLED=true
OPENAI_API_BASE=http://127.0.0.1:11434/v1
OPENAI_API_KEY=ollama
LLM_MODEL_ID=llama3.1:8b
```

### Запуск инженером (без desktop launcher)
```bash
# локально
python3 scripts/run_local_agent.py

# или через контейнеры
docker compose up -d --build
```

### Контроль качества и релиз-гейты
В репозитории добавлены guardrail-проверки, чтобы качество не деградировало между релизами:

- WER-регрессии по тестовым аудио-манифестам;
- schema/regression-проверки report/structured-выгрузок;
- e2e-сценарии браузерного захвата;
- CI/release-гейты, блокирующие публикацию при провале критичных проверок.

## Рекомендации для масштабирования на много интервьюеров
Для командного прод-внедрения обычно достаточно централизовать три вещи: дистрибуцию бинарников, единые профили качества (по языкам и типам интервью) и хранение результатов в стандартной структуре, чтобы аналитика между интервью была сопоставимой. Практически это означает: выпускать подписанные сборки, держать стабильный `LLM_MODEL_ID` для конкретного потока интервью, и регулярно прогонять WER/regression перед выкладкой обновлений.

## Ограничения
Если входной поток пришёл в экзотичном формате без валидного backup/upload источника и без доступного `ffmpeg`, качество итогового fallback MP3 будет ограничено форматом исходных чанков. Для production рекомендуется иметь `ffmpeg` в окружении desktop-сборки или в системном PATH.
